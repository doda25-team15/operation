---
- hosts: all
  vars:
    metallb_ip_range_start: "192.168.56.90"
    metallb_ip_range_end: "192.168.56.99"
    kubeconfig_path: "/home/vagrant/.kube/config"

  tasks:
    - name: Install python3-kubernetes library
      apt:
        name: python3-kubernetes
        state: present
        update_cache: yes
      become: yes

    # STEP 20 — Install MetalLB
    - name: Apply MetalLB native CRD
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        src: /vagrant/ansible/templates/metallb-native.yaml

    - name: Wait for MetalLB to be ready
      command: kubectl wait -n metallb-system -l app=metallb,component=controller --for=condition=ready pod --timeout=60s

    - name: Apply
      command: kubectl apply -f /vagrant/ansible/templates/metallb.yaml

    # STEP 21 — Install Nginx Ingress Controller
    - name: Add Nginx Ingress Helm repository
      command: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

    - name: Update Helm repositories
      command: helm repo update

    - name: Install Nginx Ingress Controller
      command: >
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
        --namespace ingress-nginx
        --create-namespace
        --set controller.service.loadBalancerIP=192.168.56.90
        --set controller.admissionWebhooks.enabled=false

    # STEP 22 — Install Kubernetes Dashboard
    - name: Add Kubernetes Dashboard Helm repository
      command: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/

    - name: Update Helm repositories for Dashboard
      command: helm repo update

    - name: Install Kubernetes Dashboard
      command: >
        helm upgrade --install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
        --namespace kubernetes-dashboard
        --create-namespace

    - name: Apply Kubernetes Dashboard Configuration
      command: kubectl apply -f /vagrant/ansible/templates/kubernetes-dashboard.yaml

    - name: Ensure openssl is installed
      apt:
        name: openssl
        state: present
        update_cache: yes
      become: yes

    - name: Create directory for dashboard certs
      file:
        path: /home/vagrant/dashboard-certs
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"
      become: yes

    - name: Generate self-signed cert for dashboard (nip.io host)
      shell: |
        openssl req -x509 -nodes -days 365 \
          -newkey rsa:2048 \
          -keyout /home/vagrant/dashboard-certs/dashboard.key \
          -out /home/vagrant/dashboard-certs/dashboard.crt \
          -subj "/CN=dashboard.192.168.56.90.nip.io"
      args:
        creates: /home/vagrant/dashboard-certs/dashboard.crt
      become: yes

    - name: Create or update kubernetes TLS secret for dashboard
      shell: |
        kubectl --kubeconfig={{ kubeconfig_path }} -n kubernetes-dashboard create secret tls kubernetes-dashboard-certs \
          --key=/home/vagrant/dashboard-certs/dashboard.key \
          --cert=/home/vagrant/dashboard-certs/dashboard.crt --dry-run=client -o yaml \
          | kubectl --kubeconfig={{ kubeconfig_path }} apply -f -
      become: yes

    # STEP 23 — Install Istio 1.25.2

    - name: Download Istio 1.25.2
      unarchive:
        src: "https://github.com/istio/istio/releases/download/1.25.2/istio-1.25.2-linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}.tar.gz"
        dest: /home/vagrant
        remote_src: yes
        owner: vagrant
        group: vagrant
      become: yes

    - name: Ensure Istio directory ownership
      file:
        path: /home/vagrant/istio-1.25.2
        owner: vagrant
        group: vagrant
        recurse: yes
      become: yes

    - name: Apply IstioOperator with MetalLB static IP
      copy:
        dest: /home/vagrant/istio-operator.yaml
        content: |
          apiVersion: install.istio.io/v1alpha1
          kind: IstioOperator
          spec:
            profile: default
            components:
              ingressGateways:
                - name: istio-ingressgateway
                  enabled: true
                  k8s:
                    service:
                      type: LoadBalancer
                      loadBalancerIP: 192.168.56.91
            meshConfig:
              accessLogFile: /dev/stdout

    - name: Install Istio using istioctl
      command: /home/vagrant/istio-1.25.2/bin/istioctl install -y -f /home/vagrant/istio-operator.yaml
      environment:
        KUBECONFIG: /home/vagrant/.kube/config

    - name: Enable Istio sidecar injection for default namespace
      command: kubectl label namespace default istio-injection=enabled --overwrite


