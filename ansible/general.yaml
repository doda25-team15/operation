---
- name: General setup for all Kubernetes nodes
  hosts: all
  gather_facts: false
  become: true

  vars:
    ssh_key_dir: "{{ playbook_dir }}/ssh-keys"
    ssh_key_files: "{{ lookup('fileglob', ssh_key_dir + '/*.pub', wantlist=True) }}"

  tasks:
    - name: Add my personal SSH key
      ansible.posix.authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"

    - name: Add all public keys from ssh_keys folder
      ansible.posix.authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', item) }}"
      loop: "{{ ssh_key_files }}"

    - name: Disable swap immediately
      ansible.builtin.shell: swapoff -a

    - name: Remove swap from fstab to prevent remount on boot
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '^\s*[^#].*\sswap\s'
        state: absent

    - name: Ensure overlay and br_netfilter modules are loaded on boot
      ansible.builtin.copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter
        owner: root
        group: root
        mode: "0644"

    - name: Load br_netfilter module now
      ansible.builtin.modprobe:
        name: br_netfilter
        state: present

    - name: Load overlay module now
      ansible.builtin.modprobe:
        name: overlay
        state: present

    - name: Configure sysctl params for Kubernetes networking
      ansible.builtin.copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
        owner: root
        group: root
        mode: "0644"

    - name: Apply sysctl parameters
      ansible.builtin.command: sysctl --system

    - name: Deploy /etc/hosts using template
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/hosts.j2"
        dest: /etc/hosts
        owner: root
        group: root
        mode: "0644"

    - name: Install apt prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gpg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Kubernetes apt repository GPG key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key
        state: present

    - name: Add Kubernetes apt repository
      apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /"
        state: present

    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install containerd and runc
      apt:
        name:
          - containerd
          - runc
        state: present
        update_cache: yes

    - name: Install basic Kubernetes tools
      apt:
        name:
          - kubeadm=1.32.4-1.1
          - kubelet=1.32.4-1.1
          - kubectl=1.32.4-1.1
        state: present
        update_cache: yes

    - name: Hold kubeadm, kubelet and kubectl to prevent unintended upgrades
      apt:
        name:
          - kubeadm
          - kubelet
          - kubectl
        state: present
      register: hold_check

    - name: Mark kube packages on hold (apt-mark hold)
      command: "apt-mark hold kubelet kubeadm kubectl"

    - name: Generate default containerd config
      command: containerd config default
      register: containerd_default_config

    - name: Ensure /etc/containerd exists
      file:
        path: /etc/containerd
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Disable AppArmor in containerd config
      copy:
        dest: /etc/containerd/config.toml
        content: '{{ containerd_default_config.stdout
          | regex_replace(''disable_apparmor\\s*=\\s*(true|false)'', ''disable_apparmor = true'') }}'
        mode: "0644"

    - name: Update pause sandbox image in config.toml
      copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_default_config.stdout
          | regex_replace('sandbox_image\\s*=\\s*\".*\"', 'sandbox_image = \"registry.k8s.io/pause:3.10\"') }}"
        mode: "0644"

    - name: Set SystemdCgroup = true
      copy:
        dest: /etc/containerd/config.toml
        content: "{{ containerd_default_config.stdout
          | regex_replace('SystemdCgroup\\s*=\\s*(true|false)', 'SystemdCgroup = true') }}"
        mode: "0644"

    - name: Restart containerd to apply configuration
      service:
        name: containerd
        state: restarted
        enabled: yes
        
    - name: Ensure kubelet is enabled and started
      service:
        name: kubelet
        state: started
        enabled: yes


