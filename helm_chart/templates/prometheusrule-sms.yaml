apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: sms-checker-alerts
  namespace: default
  labels:
    release: sms-checker
spec:
  groups:
  - name: sms-checker.rules
    rules:
    - alert: HighSmsUserRequestSpike
      # This rule counts only requests that originate from an ingress workload
      # (either Istio ingressgateway or ingress-nginx). It helps ignore internal
      # traffic such as monitoring or node-exporter probes.
      expr: |
        rate(
          istio_requests_total{
            destination_workload=~"app-deployment.*|app-service.*",
            source_workload=~"istio-ingressgateway.*|ingress-nginx-controller.*"
          }[1m]
        ) > 15
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: '{{"{{"}} $value {{"}}"}} user requests in last 1m'
        description: 'Spike of user-originating requests detected (source_workload={{"{{"}} $labels.source_workload {{"}}"}})'
